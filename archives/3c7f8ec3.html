<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>秒杀项目 | Daggry House</title><meta name="author" content="Daggry"><meta name="copyright" content="Daggry"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="秒杀项目笔记">
<meta property="og:type" content="article">
<meta property="og:title" content="秒杀项目">
<meta property="og:url" content="http://sazxsdawn2022.github.io/archives/3c7f8ec3.html">
<meta property="og:site_name" content="Daggry House">
<meta property="og:description" content="秒杀项目笔记">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/sazxsdawn2022/picgoimg/duskimg/seckill/seckill.png">
<meta property="article:published_time" content="2023-03-29T16:00:00.000Z">
<meta property="article:modified_time" content="2023-03-30T12:00:00.000Z">
<meta property="article:author" content="Daggry">
<meta property="article:tag" content="秒杀">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/sazxsdawn2022/picgoimg/duskimg/seckill/seckill.png"><link rel="shortcut icon" href="/img/tb.png"><link rel="canonical" href="http://sazxsdawn2022.github.io/archives/3c7f8ec3.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="baidu-site-verification" content="codeva-dkeX8im1Rp"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":true,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":1,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Daggry","link":"链接: ","source":"来源: Daggry House","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '秒杀项目',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-03-30 20:00:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/tx.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">32</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">11</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fas fa-list"></i><span> 链接</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/sazxsdawn2022/picgoimg/duskimg/seckill/seckill.png')"><nav id="nav"><span id="blog-info"><a href="/" title="Daggry House"><span class="site-name">Daggry House</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fas fa-list"></i><span> 链接</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">秒杀项目</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-03-29T16:00:00.000Z" title="发表于 2023-03-30 00:00:00">2023-03-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-03-30T12:00:00.000Z" title="更新于 2023-03-30 20:00:00">2023-03-30</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">10.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>45分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="秒杀项目"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="1、项目介绍"><a href="#1、项目介绍" class="headerlink" title="1、项目介绍"></a>1、项目介绍</h1><p> 本项目基于Springboot+Mysql+Redis+RibbitMQ+MyBatis-Plus等技术，保证了在高并发的情况下秒杀活动的 顺利进行。</p>
<h1 id="2、项目总结"><a href="#2、项目总结" class="headerlink" title="2、项目总结"></a>2、项目总结</h1><ul>
<li>首先基本秒杀功能实现</li>
<li>用redis进行优化，页面缓存，user对象缓存</li>
<li>解决复购和超卖</li>
<li>优化秒杀，逐步减少直接操作DB，操作reids</li>
<li>解决秒杀安全问题</li>
</ul>
<h1 id="3、项目功能实现"><a href="#3、项目功能实现" class="headerlink" title="3、项目功能实现"></a>3、项目功能实现</h1><h2 id="分布式会话-Session"><a href="#分布式会话-Session" class="headerlink" title="分布式会话&#x2F;Session"></a>分布式会话&#x2F;Session</h2><h3 id="用户登录"><a href="#用户登录" class="headerlink" title="用户登录"></a>用户登录</h3><h4 id="用户登录-基础功能"><a href="#用户登录-基础功能" class="headerlink" title="用户登录-基础功能"></a>用户登录-基础功能</h4><p><strong>需求说明</strong><br>完成用户登录<br><strong>表结构设计</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `seckill_user` (</span><br><span class="line">`id` <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户 ID, 设为主键, 唯一手机号&#x27;</span>,  <span class="comment">--是手机号</span></span><br><span class="line">`nickname` <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>, </span><br><span class="line">`password` <span class="type">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;MD5(MD5(pass 明文+固定salt)+salt)&#x27;</span>, </span><br><span class="line">`slat` <span class="type">VARCHAR</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">`head` <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;头像&#x27;</span>, </span><br><span class="line">`register_date` DATETIME <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;注册时间&#x27;</span>, </span><br><span class="line">`last_login_date` DATETIME <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;最后一次登录时间&#x27;</span>, </span><br><span class="line">`login_count` <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;登录次数&#x27;</span>,</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br></pre></td></tr></table></figure>
<p><strong>密码的设计：两次加盐</strong></p>
<ul>
<li>客户端—-md5(password 明文+<strong>salt1</strong>)–&gt; 后端(** md5(md5(password 明文+salt1)+salt2)** &#x3D;&#x3D;db中存放的 password 是否一致 ?)</li>
<li>通过在原始密码（字符串）的前后加上一个字符来生成 md5 加密后的密码（进行两次操作）<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hspedu.seckill.util;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.codec.digest.DigestUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * MD5Util: 工具类，根据前面密码设计方案提供相应的方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MD5Util</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//最基本的md5加密</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">md5</span><span class="params">(String src)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DigestUtils.md5Hex(src);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//准备一个salt [前端使用盐]</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SALT</span> <span class="operator">=</span> <span class="string">&quot;4tIY5VcX&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//加密加盐, 完成的任务就是 md5(password明文+salt1)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">inputPassToMidPass</span><span class="params">(String inputPass)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;SALT.charAt(0)-&gt;&quot;</span> + SALT.charAt(<span class="number">0</span>));<span class="comment">//c</span></span><br><span class="line">        System.out.println(<span class="string">&quot;SALT.charAt(6)-&gt;&quot;</span> + SALT.charAt(<span class="number">6</span>));<span class="comment">//T</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> SALT.charAt(<span class="number">0</span>) + inputPass + SALT.charAt(<span class="number">6</span>);</span><br><span class="line">        <span class="keyword">return</span> md5(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//加密加盐, 完成的任务就是把(MidPass +salt2) 转成DB中的密码</span></span><br><span class="line">    <span class="comment">// md5(md5(password明文+salt1)+salt2)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">midPassToDBPass</span><span class="params">(String midPass, String salt)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;salt.charAt(1)-&gt;&quot;</span> + salt.charAt(<span class="number">1</span>));<span class="comment">//L</span></span><br><span class="line">        System.out.println(<span class="string">&quot;salt.charAt(5)-&gt;&quot;</span> + salt.charAt(<span class="number">5</span>));<span class="comment">//m</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> salt.charAt(<span class="number">1</span>) + midPass + salt.charAt(<span class="number">5</span>);</span><br><span class="line">        <span class="keyword">return</span> md5(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//编写一个方法，可以将password明文，直接转成DB中的密码</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">inputPassToDBPass</span><span class="params">(String inputPass, String salt)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">midPass</span> <span class="operator">=</span> inputPassToMidPass(inputPass);</span><br><span class="line">        <span class="type">String</span> <span class="variable">dbPass</span> <span class="operator">=</span> midPassToDBPass(midPass, salt);</span><br><span class="line">        <span class="keyword">return</span> dbPass;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<strong>登录信息、秒杀商品信息设计</strong><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * LoginVo: 接收用户登录时，发送的信息(mobile,password)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginVo</span> &#123;</span><br><span class="line">    <span class="comment">//对LoginVo的属性值进行，约束</span></span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@IsMobile</span></span><br><span class="line">    <span class="keyword">private</span> String mobile;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Length(min = 32)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * GoodsVo: 对应就是显示再秒杀商品列表的信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GoodsVo</span> <span class="keyword">extends</span> <span class="title class_">Goods</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal seckillPrice;	<span class="comment">//秒杀价格</span></span><br><span class="line">    <span class="keyword">private</span> Integer stockCount;			<span class="comment">//秒杀商品库存</span></span><br><span class="line">    <span class="keyword">private</span> Date startDate;				<span class="comment">//秒杀开始时间</span></span><br><span class="line">    <span class="keyword">private</span> Date endDate;				<span class="comment">//秒杀结束时间</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<strong>请求返回信息设计</strong><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RespBean</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> code;		<span class="comment">//状态码</span></span><br><span class="line">    <span class="keyword">private</span> String message;  <span class="comment">//返回的信息</span></span><br><span class="line">    <span class="keyword">private</span> Object obj;  	<span class="comment">//返回的数据</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//成功后-同时携带数据</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> RespBean <span class="title function_">success</span><span class="params">(Object data)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RespBean</span>(RespBeanEnum.SUCCESS.getCode(), RespBeanEnum.SUCCESS.getMessage(), data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//成功后-不携带数据</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> RespBean <span class="title function_">success</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RespBean</span>(RespBeanEnum.SUCCESS.getCode(), RespBeanEnum.SUCCESS.getMessage(), <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//失败各有不同-返回失败信息时，不携带数据</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> RespBean <span class="title function_">error</span><span class="params">(RespBeanEnum respBeanEnum)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RespBean</span>(respBeanEnum.getCode(), respBeanEnum.getMessage(), <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//失败各有不同-返回失败信息时，同时携带数据</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> RespBean <span class="title function_">error</span><span class="params">(RespBeanEnum respBeanEnum, Object data)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RespBean</span>(respBeanEnum.getCode(), respBeanEnum.getMessage(), data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * RespBeanEnum: 枚举类如何开发，java基础讲过</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">RespBeanEnum</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通用</span></span><br><span class="line">    SUCCESS(<span class="number">200</span>,<span class="string">&quot;SUCCESS&quot;</span>),</span><br><span class="line">    ERROR(<span class="number">500</span>,<span class="string">&quot;服务端异常&quot;</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">//登录</span></span><br><span class="line">    LOGIN_ERROR(<span class="number">500210</span>,<span class="string">&quot;用户id或者密码错误&quot;</span>),</span><br><span class="line">    BING_ERROR(<span class="number">500212</span>,<span class="string">&quot;参数绑定异常~&quot;</span>),</span><br><span class="line">    MOBILE_ERROR(<span class="number">500211</span>, <span class="string">&quot;手机号码格式不正确&quot;</span>),</span><br><span class="line">    MOBILE_NOT_EXIST(<span class="number">500213</span>,<span class="string">&quot;手机号码不存在&quot;</span>),</span><br><span class="line">    PASSWROD_UPDATE_FAIL(<span class="number">500214</span>,<span class="string">&quot;密码更新失败&quot;</span>),</span><br><span class="line">    <span class="comment">//其它我们在开发过程中，灵活增加即可</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//秒杀模块-返回的信息</span></span><br><span class="line">    ENTRY_STOCK(<span class="number">500500</span>,<span class="string">&quot;库存不足&quot;</span>),</span><br><span class="line">    REPEAT_ERROR(<span class="number">500501</span>,<span class="string">&quot;该商品每人限购一件&quot;</span>),</span><br><span class="line">    REQUEST_ILLEGAL(<span class="number">500502</span>,<span class="string">&quot;请求非法&quot;</span>),</span><br><span class="line">    SESSION_ERROR(<span class="number">500503</span>,<span class="string">&quot;用户信息有误..&quot;</span>),</span><br><span class="line">    SEK_KILL_WAIT(<span class="number">500504</span>,<span class="string">&quot;排队中...&quot;</span>),</span><br><span class="line">    CAPTCHA_ERROR(<span class="number">500505</span>,<span class="string">&quot;验证码错误...&quot;</span>),</span><br><span class="line">    ACCESS_LIMIT_REACHED(<span class="number">500506</span>,<span class="string">&quot;访问频繁,请待会再试...&quot;</span>),</span><br><span class="line">    SEC_KILL_RETRY(<span class="number">500507</span>,<span class="string">&quot;本次抢购失败,请继续抢购..&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Integer code;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String message;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<strong>手机号码格式校验</strong><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ValidatorUtil: 完成一些校验工作,比如手机号码格式是否正确..</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public class ValidatorUtil &#123;</span><br><span class="line"></span><br><span class="line">    <span class="operator">/</span><span class="operator">/</span>校验手机号码的正则表达式</span><br><span class="line">    <span class="operator">/</span><span class="operator">/</span><span class="number">13300000000</span> 合格</span><br><span class="line">    <span class="operator">/</span><span class="operator">/</span><span class="number">11000000000</span> 不合格</span><br><span class="line">    private <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">Pattern</span> mobile_pattern <span class="operator">=</span> Pattern.compile(&quot;^[1][3-9][0-9]&#123;9&#125;$&quot;);</span><br><span class="line"></span><br><span class="line">    <span class="operator">/</span><span class="operator">/</span>编写方法, 如果满足规则，返回T, 否则返回F</span><br><span class="line">    public <span class="keyword">static</span> <span class="type">boolean</span> isMobile(String mobile) &#123;</span><br><span class="line">        if(<span class="operator">!</span>StringUtils.hasText(mobile)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="operator">/</span><span class="operator">/</span>进行正则表达式校验<span class="operator">-</span>java基础讲过</span><br><span class="line">        Matcher matcher <span class="operator">=</span> mobile_pattern.matcher(mobile);</span><br><span class="line">        <span class="keyword">return</span> matcher.matches();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="自定义校验注解"><a href="#自定义校验注解" class="headerlink" title="自定义校验注解"></a>自定义校验注解</h4><p>具体实现</p>
<h4 id="记录登录用户Session"><a href="#记录登录用户Session" class="headerlink" title="记录登录用户Session"></a>记录登录用户Session</h4><p>有一个CookieUtil，便于操作Cookie，直接拿来使用就行<br><strong>doLogin</strong></p>
<ul>
<li>在 UserServiceImpl  中根据 LoginVo 到数据库中查</li>
<li>查到后用 java.util.UUID 工具类生成票据 Ticket 用来区分 user，存入session中request.getSession().setAttribute**(ticket, user)**;</li>
<li>将票据存放到Cookie中 <strong>（”userTicket”, ticket）</strong></li>
</ul>
<p><strong>获取商品列表</strong></p>
<ul>
<li>有了 Cookie 和 Session 就可以在获取商品列表时进行判断了</li>
<li>先通过判断请求是否有userTicket，没有则返回登录</li>
<li>有则从Session中通过ticket（这个ticket就是userTicket）获取user</li>
<li>将user放入到Model传给下一个页面使用（user中包含了user的所有信息）</li>
</ul>
<h3 id="分布式Session共享"><a href="#分布式Session共享" class="headerlink" title="分布式Session共享"></a>分布式Session共享</h3><p><strong>需求说明</strong><br>Nginx对请求负载均衡到不同的Tomcat，当第二次请求到不同的Tomcat时，Tomcat会认为该用户是第一次购买，就会出现重复购买的问题。所以要进行Session共享。<br><strong>解决方案：</strong></p>
<ul>
<li>Session绑定&#x2F;粘滞</li>
<li>Session复制</li>
<li>前端存储</li>
<li>后端集中存储</li>
</ul>
<h4 id="SpringSession-实现分布式-Session"><a href="#SpringSession-实现分布式-Session" class="headerlink" title="SpringSession 实现分布式 Session"></a>SpringSession 实现分布式 Session</h4><p> <strong>描述：</strong>将用户 Session 不再存放到各自登录的 Tomcat 服务器，而是统一存在Redis  </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--spring data redis 依赖, 即 spring 整合 redis--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--pool2 对象池依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--实现分布式 session, 即将 Session 保存到指定的 Redis--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.session<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-session-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment">#配置redis</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.200</span><span class="number">.130</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">10000ms</span></span><br><span class="line">    <span class="attr">lettuce:</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="attr">max-active:</span> <span class="number">8</span>  <span class="comment">#最大连接数，默认是8</span></span><br><span class="line">        <span class="attr">max-wait:</span> <span class="string">10000ms</span> <span class="comment">#最大连接等待时间，默认是-1 一直等待</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">200</span>  <span class="comment">#最大空闲连接，高并发的情况下会来回切换连接</span></span><br><span class="line">        <span class="attr">min-idle:</span> <span class="number">5</span>  <span class="comment">#最小空闲连接数，默认是0</span></span><br></pre></td></tr></table></figure>
<p>将user保存到session中改为保存到redis中： </p>
<ul>
<li>配置完后执行这句话 request.getSession().setAttribute(ticket, user); 就把session保存到redis中了</li>
<li>是以<strong>原始的形式</strong>保存的（保存的有session过期时间，最后访问时间等）</li>
</ul>
<h4 id="直接将用户信息统一放到Redis"><a href="#直接将用户信息统一放到Redis" class="headerlink" title="直接将用户信息统一放到Redis"></a>直接将用户信息统一放到Redis</h4><p>**描述： **前面将 Session 统一存放指定 Redis, 是以原生的形式存放, 在操作时, 还需要反序列化，不方便，我们可以直接将登录用户信息统一存放到 Redis, 利于操作<br>注销掉上面引入的spring-session-data-redis</p>
<ul>
<li><strong>使用 redisTemplate.opsForValue().set(“user:” + ticket, user);</strong></li>
<li>在Redis中key是 user: ticket 的格式</li>
<li>实现根据userTicket票据的Cookie 到 Redis中获取 user对象</li>
<li>刷新Cookie重新计算userTicket的过期时间</li>
</ul>
<p>GoodController中的toList方法改为直接从redis中获取user，然后放到Model中供下面使用</p>
<h4 id="WebMvcConfiger优化登录"><a href="#WebMvcConfiger优化登录" class="headerlink" title="WebMvcConfiger优化登录"></a>WebMvcConfiger优化登录</h4><h2 id="秒杀基本功能开发"><a href="#秒杀基本功能开发" class="headerlink" title="秒杀基本功能开发"></a>秒杀基本功能开发</h2><h3 id="商品列表"><a href="#商品列表" class="headerlink" title="商品列表"></a>商品列表</h3><p><strong>需求说明</strong><br>登录成功后可以看到商品列表<br><strong>表结构设计</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t_goods` (</span><br><span class="line">`id` <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;商品 id&#x27;</span>, </span><br><span class="line">`goods_name` <span class="type">VARCHAR</span>(<span class="number">16</span>) <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>, </span><br><span class="line">`goods_title` <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;商品标题&#x27;</span>, </span><br><span class="line">`goods_img` <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;商品图片&#x27;</span>, </span><br><span class="line">`goods_detail` LONGTEXT <span class="keyword">not</span> <span class="keyword">null</span> COMMENT <span class="string">&#x27;商品详情&#x27;</span>,</span><br><span class="line">`goods_price` <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0.00&#x27;</span> COMMENT <span class="string">&#x27;商品价格&#x27;</span>, </span><br><span class="line">`goods_stock` <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;商品库存&#x27;</span>, </span><br><span class="line"><span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB AUTO_INCREMENT<span class="operator">=</span><span class="number">3</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br></pre></td></tr></table></figure>
<p>重点是id、库存</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t_seckill_goods` (</span><br><span class="line">`id` <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT, </span><br><span class="line">`goods_id` <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="number">0</span>, </span><br><span class="line">`seckill_price` <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0.00&#x27;</span>, </span><br><span class="line">`stock_count` <span class="type">INT</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="number">0</span>, </span><br><span class="line">`start_date` DATETIME <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>, </span><br><span class="line">`end_date` DATETIME <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>, </span><br><span class="line"><span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB AUTO_INCREMENT<span class="operator">=</span><span class="number">3</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br></pre></td></tr></table></figure>
<p>goods_id就是 t_goods 的主键<br><strong>设计GoodsVo</strong>，继承了Goods</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GoodsVo</span> <span class="keyword">extends</span> <span class="title class_">Goods</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BigDecimal seckillPrice;</span><br><span class="line">    <span class="keyword">private</span> Integer stockCount;</span><br><span class="line">    <span class="keyword">private</span> Date startDate;</span><br><span class="line">    <span class="keyword">private</span> Date endDate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>查询GoodsVo商品逻辑</strong><br><strong>把从Redis中查询到的user放model中后，再把从数据库中查出的商品放到model中</strong><br>model.addAttribute(“goodsList”, goodsService.findGoodsVo());</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;findGoodsVo&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.hspedu.seckill.vo.GoodsVo&quot;</span>&gt;</span></span><br><span class="line">    SELECT g.id,</span><br><span class="line">           g.goods_name,</span><br><span class="line">           g.goods_title,</span><br><span class="line">           g.goods_img,</span><br><span class="line">           g.goods_detail,</span><br><span class="line">           g.goods_price,</span><br><span class="line">           g.goods_stock,</span><br><span class="line">           sg.seckill_price,</span><br><span class="line">           sg.stock_count,</span><br><span class="line">           sg.start_date,</span><br><span class="line">           sg.end_date</span><br><span class="line">    FROM t_goods g</span><br><span class="line">    LEFT JOIN t_seckill_goods sg</span><br><span class="line">    ON g.id = sg.goods_id</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>商品表左连接秒杀商品表</p>
<h3 id="商品详情页"><a href="#商品详情页" class="headerlink" title="商品详情页"></a>商品详情页</h3><p><strong>需求说明</strong><br>在商品列表中点击查看详情会看到秒杀商品详情页<br><strong>实现逻辑</strong><br>在GoodsMapper中增加通过商品id获取GoodVo</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;findGoodsVoByGoodsId&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.hspedu.seckill.vo.GoodsVo&quot;</span>&gt;</span></span><br><span class="line">    SELECT</span><br><span class="line">        g.id,</span><br><span class="line">        g.goods_name,</span><br><span class="line">        g.goods_title,</span><br><span class="line">        g.goods_img,</span><br><span class="line">        g.goods_detail,</span><br><span class="line">        g.goods_price,</span><br><span class="line">        g.goods_stock,</span><br><span class="line">        sg.seckill_price,</span><br><span class="line">        sg.stock_count,</span><br><span class="line">        sg.start_date,</span><br><span class="line">        sg.end_date</span><br><span class="line">    FROM t_goods g</span><br><span class="line">    LEFT JOIN t_seckill_goods sg</span><br><span class="line">    ON g.id = sg.goods_id</span><br><span class="line">    WHERE g.id=#&#123;goodsId&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>接入前端，根据秒杀开始时间和结束时间，在前端秒杀商品详情页有不同的显示：</p>
<ul>
<li>秒杀倒计时</li>
<li>秒杀进行中</li>
<li>秒杀结束</li>
</ul>
<h3 id="秒杀基本实现"><a href="#秒杀基本实现" class="headerlink" title="秒杀基本实现"></a>秒杀基本实现</h3><p><strong>需求说明</strong></p>
<ul>
<li>点击进行秒杀，更新库存，保存普通订单，秒杀订单</li>
<li>秒杀完成后进入秒杀订单页</li>
<li>只是最基本的功能，高并发下存在超卖的问题</li>
</ul>
<h4 id="功能1-秒杀倒计时"><a href="#功能1-秒杀倒计时" class="headerlink" title="功能1-秒杀倒计时"></a>功能1-秒杀倒计时</h4><p>在GoodsController的 toDetail 加入<br>根据查到的GoodVo的开始结束时间来鉴定秒杀状态</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//返回秒杀商品详情的同时返回该商品秒杀的状态和秒杀剩余的时间</span></span><br><span class="line"><span class="comment">//为了配合前端展示秒杀商品的状态 - 这里依然有一个业务设计</span></span><br><span class="line"><span class="comment">//1. 变量 secKillStatus 秒杀状态 0:秒杀未开始 1: 秒杀进行中 2: 秒杀已经结束</span></span><br><span class="line"><span class="comment">//2. 变量 remainSeconds 剩余秒数: &gt;0: 表示还有多久开始秒杀: 0: 秒杀进行中 -1: 表示秒杀已经结束</span></span><br><span class="line"><span class="type">Date</span> <span class="variable">startDate</span> <span class="operator">=</span> goodsVo.getStartDate();</span><br><span class="line"><span class="type">Date</span> <span class="variable">endDate</span> <span class="operator">=</span> goodsVo.getEndDate();</span><br><span class="line"><span class="type">Date</span> <span class="variable">nowDate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line"><span class="comment">//秒杀状态</span></span><br><span class="line"><span class="type">int</span> <span class="variable">secKillStatus</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="comment">//秒杀距离开始的剩余时间（单位是秒）</span></span><br><span class="line"><span class="type">int</span> <span class="variable">remainSeconds</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (nowDate.before(startDate)) &#123;</span><br><span class="line">    secKillStatus = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//得到还有多少秒开始秒杀</span></span><br><span class="line">    remainSeconds = (<span class="type">int</span>) ((startDate.getTime() - nowDate.getTime()) / <span class="number">1000</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (nowDate.after(endDate)) &#123;</span><br><span class="line">    secKillStatus = <span class="number">2</span>;</span><br><span class="line">    remainSeconds = -<span class="number">1</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    secKillStatus = <span class="number">1</span>;</span><br><span class="line">    remainSeconds = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//将secKillStatus 和 remainSeconds放入到model ,携带给模板页使用</span></span><br><span class="line">model.addAttribute(<span class="string">&quot;secKillStatus&quot;</span>, secKillStatus);</span><br><span class="line">model.addAttribute(<span class="string">&quot;remainSeconds&quot;</span>, remainSeconds);</span><br></pre></td></tr></table></figure>
<h4 id="功能2-秒杀按钮"><a href="#功能2-秒杀按钮" class="headerlink" title="功能2-秒杀按钮"></a>功能2-秒杀按钮</h4><p>前端实现的，就是按钮不到秒杀期间不能点</p>
<h4 id="功能3-点击按钮可以秒杀"><a href="#功能3-点击按钮可以秒杀" class="headerlink" title="功能3-点击按钮可以秒杀"></a>功能3-点击按钮可以秒杀</h4><p>秒杀成功后秒杀按钮变为立即支付，<strong>重复秒杀</strong>，<strong>库存不足</strong>都会秒杀失败（判断复购，库存）<br><strong>表设计</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t_order` (</span><br><span class="line">`id` <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT, </span><br><span class="line">`user_id` <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>, </span><br><span class="line">`goods_id` <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>, </span><br><span class="line">`delivery_addr_id` <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>, </span><br><span class="line">`goods_name` <span class="type">VARCHAR</span>(<span class="number">16</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>, </span><br><span class="line">`goods_count` <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">`goods_price` <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0.00&#x27;</span>, </span><br><span class="line">`order_channel` TINYINT(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;订单渠道1pc，2Android，3ios&#x27;</span>, </span><br><span class="line">`status` TINYINT(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;订单状态：0 新建未支付1已支付2 已发货 3 已收货 4 已退款 5 已完成&#x27;</span>,</span><br><span class="line">`create_date` DATETIME <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>, `pay_date` DATETIME <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB AUTO_INCREMENT<span class="operator">=</span><span class="number">600</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t_seckill_order` (</span><br><span class="line">`id` <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT, </span><br><span class="line">`user_id` <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>, </span><br><span class="line">`order_id` <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>, </span><br><span class="line">`goods_id` <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line"><span class="keyword">UNIQUE</span> KEY `seckill_uid_gid` (`user_id`,`goods_id`) <span class="keyword">USING</span> BTREE COMMENT <span class="string">&#x27; 用户id，商品 id 的唯一索引，解决同一个用户多次抢购&#x27;</span> ) </span><br><span class="line">ENGINE<span class="operator">=</span>INNODB AUTO_INCREMENT<span class="operator">=</span><span class="number">300</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br></pre></td></tr></table></figure>
<p><strong>秒杀逻辑</strong><br> <strong>用户id，商品 id 的唯一索引，解决同一个用户多次抢购’  **<br>SeckillController 中的 doSeckill 方法</strong>版本1**：</p>
<ul>
<li><p>由商品列表页带来的user，供后面保存订单来使用</p>
</li>
<li><p>根据商品id直接从数据库中取出商品，看商品库存是否大于0</p>
</li>
<li><p>根据商品id和userId到数据库秒杀商品表中查询，进而判断该用户是否已经秒杀了该商品</p>
</li>
<li><p>通过了上面两个判断之后进入**orderService.seckill(user, goodsVo)**秒杀商品，生成订单</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//处理用户抢购请求/秒杀</span></span><br><span class="line"><span class="comment">//说明：我们先完成一个V1.0版本，后面在高并发的情况下, 还要做优化</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/doSeckill&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">doSeckill</span><span class="params">(Model model, User user, Long goodsId)</span> &#123;</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;------秒杀V1.0 开始-------&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;<span class="comment">//用户没有登录</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//将user放入到model, 下一个模板可以使用</span></span><br><span class="line">    model.addAttribute(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">    <span class="comment">//获取到goodsVo</span></span><br><span class="line">    <span class="type">GoodsVo</span> <span class="variable">goodsVo</span> <span class="operator">=</span> goodsService.findGoodsVoByGoodsId(goodsId);</span><br><span class="line">    <span class="comment">//判断库存</span></span><br><span class="line">    <span class="keyword">if</span> (goodsVo.getStockCount() &lt; <span class="number">1</span>) &#123;<span class="comment">//没有库存</span></span><br><span class="line">        model.addAttribute(<span class="string">&quot;errmsg&quot;</span>, RespBeanEnum.ENTRY_STOCK.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;secKillFail&quot;</span>;<span class="comment">//错误页面</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断用户是否复购-判断当前购买用户id和购买商品id是否已经在 商品秒杀表存在了</span></span><br><span class="line">    <span class="type">SeckillOrder</span> <span class="variable">seckillOrder</span> <span class="operator">=</span> seckillOrderService.getOne(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;SeckillOrder&gt;().eq(<span class="string">&quot;user_id&quot;</span>, user.getId())</span><br><span class="line">                    .eq(<span class="string">&quot;goods_id&quot;</span>, goodsId));</span><br><span class="line">    <span class="keyword">if</span> (seckillOrder != <span class="literal">null</span>) &#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;errmsg&quot;</span>, RespBeanEnum.REPEAT_ERROR.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;secKillFail&quot;</span>;<span class="comment">//错误页面</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//抢购</span></span><br><span class="line">    <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderService.seckill(user, goodsVo);</span><br><span class="line">    <span class="keyword">if</span> (order == <span class="literal">null</span>) &#123; <span class="comment">//有可能执行过程中出错</span></span><br><span class="line">        model.addAttribute(<span class="string">&quot;errmsg&quot;</span>, RespBeanEnum.ENTRY_STOCK.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;secKillFail&quot;</span>;<span class="comment">//错误页面</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//进入到订单页</span></span><br><span class="line">    model.addAttribute(<span class="string">&quot;order&quot;</span>, order);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;goods&quot;</span>, goodsVo);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;------秒杀V1.0 结束-------&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;orderDetail&quot;</span>; <span class="comment">//进入订单详情页</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个<strong>seckill</strong>方法是用来更新库存，保存普通订单，商品订单的</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Order <span class="title function_">seckill</span><span class="params">(User user, GoodsVo goodsVo)</span> &#123;</span><br><span class="line">    <span class="comment">//认为能进到这个代码中就是可以秒杀</span></span><br><span class="line">    <span class="comment">//查询秒杀商品的库存,并-1</span></span><br><span class="line">    <span class="type">SeckillGoods</span> <span class="variable">seckillGoods</span> <span class="operator">=</span> seckillGoodsService.</span><br><span class="line">            getOne(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;SeckillGoods&gt;().eq(<span class="string">&quot;goods_id&quot;</span>, goodsVo.getId()));</span><br><span class="line">    <span class="comment">//完成一个基本的秒杀操作[这块不具原子性],后面在高并发的情况下,还会优化, 不用急</span></span><br><span class="line">    seckillGoods.setStockCount(seckillGoods.getStockCount() - <span class="number">1</span>);</span><br><span class="line">    seckillGoodsService.updateById(seckillGoods);</span><br></pre></td></tr></table></figure>
<p><strong>版本1的问题</strong></p>
</li>
<li><p>从数据库拿出秒杀商品，减库存后更新到数据库，<strong>这两步操作不具备原子性</strong></p>
</li>
<li><p>查用户，查秒杀订单判断是否复购<strong>都是从数据库中查的</strong></p>
</li>
</ul>
<h2 id="秒杀压测Jmeter"><a href="#秒杀压测Jmeter" class="headerlink" title="秒杀压测Jmeter"></a>秒杀压测Jmeter</h2><h3 id="多用户测试"><a href="#多用户测试" class="headerlink" title="多用户测试"></a>多用户测试</h3><p><strong>测试方法</strong><br><img src="https://cdn.jsdelivr.net/gh/sazxsdawn2022/picgoimg/duskimg/seckill/img1.png" alt="image.png"><br><strong>生成多用户测试脚本</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * UserUtil: 生成多用户测试脚本</span></span><br><span class="line"><span class="comment"> * 1. 创建多个用户,保存到seckill_user表</span></span><br><span class="line"><span class="comment"> * 2. 模拟http请求,生成jmeter压测的脚本</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">//生成多用户工具类</span></span><br><span class="line"><span class="comment">//创建用户，并且去登录得到userticket，得到的userTicket写入到config.txt文件内</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserUtil</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">create</span><span class="params">(<span class="type">int</span> count)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        List&lt;User&gt; users = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(count);</span><br><span class="line">        <span class="comment">//count表示你要创建的用户个数</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">            user.setId(<span class="number">13300000100L</span> + i);</span><br><span class="line">            user.setNickname(<span class="string">&quot;user&quot;</span> + i);</span><br><span class="line">            <span class="comment">//小伙伴也可以生成不同的盐,这里老师就是有一个</span></span><br><span class="line">            user.setSlat(<span class="string">&quot;ptqtXy16&quot;</span>);<span class="comment">//用户数据表的slat,由程序员设置</span></span><br><span class="line">            <span class="comment">//?是用户原始密码,比如12345 , hello等</span></span><br><span class="line">            <span class="comment">//小伙伴也可以生成不同的密码</span></span><br><span class="line">            user.setPassword(MD5Util.inputPassToDBPass(<span class="string">&quot;12345&quot;</span>, user.getSlat()));</span><br><span class="line">            users.add(user);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;create user&quot;</span>);</span><br><span class="line">        <span class="comment">//将插入数据库-seckill_user</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> getConn();</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;insert into seckill_user(nickname,slat,password,id) values(?,?,?,?)&quot;</span>;</span><br><span class="line">        <span class="type">PreparedStatement</span> <span class="variable">preparedStatement</span> <span class="operator">=</span> connection.prepareStatement(sql);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; users.size(); i++) &#123;</span><br><span class="line">            <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> users.get(i);</span><br><span class="line">            preparedStatement.setString(<span class="number">1</span>, user.getNickname());</span><br><span class="line">            preparedStatement.setString(<span class="number">2</span>, user.getSlat());</span><br><span class="line">            preparedStatement.setString(<span class="number">3</span>, user.getPassword());</span><br><span class="line">            preparedStatement.setLong(<span class="number">4</span>, user.getId());</span><br><span class="line">            preparedStatement.addBatch();</span><br><span class="line">        &#125;</span><br><span class="line">        preparedStatement.executeBatch();</span><br><span class="line">        preparedStatement.clearParameters();<span class="comment">//关闭</span></span><br><span class="line">        connection.close();</span><br><span class="line">        System.out.println(<span class="string">&quot;insert to do&quot;</span>);</span><br><span class="line">        <span class="comment">//模拟登录,发出登录拿到userTicket</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">urlStr</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8080/login/doLogin&quot;</span>;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\aHspJava\\projects\\iSecKill\\tool\\temp\\config.txt&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (file.exists()) &#123;</span><br><span class="line">            file.delete();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">RandomAccessFile</span> <span class="variable">raf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(file, <span class="string">&quot;rw&quot;</span>);</span><br><span class="line">        raf.seek(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; users.size(); i++) &#123;</span><br><span class="line">            <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> users.get(i);</span><br><span class="line">            <span class="comment">//请求</span></span><br><span class="line">            <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(urlStr);</span><br><span class="line">            <span class="comment">//使用HttpURLConnection 发出http请求</span></span><br><span class="line">            <span class="type">HttpURLConnection</span> <span class="variable">co</span> <span class="operator">=</span> (HttpURLConnection) url.openConnection();</span><br><span class="line">            co.setRequestMethod(<span class="string">&quot;POST&quot;</span>);</span><br><span class="line">            <span class="comment">//设置输入网页密码（相当于输出到页面）</span></span><br><span class="line">            co.setDoOutput(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> co.getOutputStream();</span><br><span class="line">            <span class="type">String</span> <span class="variable">params</span> <span class="operator">=</span> <span class="string">&quot;mobile=&quot;</span> + user.getId() + <span class="string">&quot;&amp;password=&quot;</span> + MD5Util.inputPassToMidPass(<span class="string">&quot;12345&quot;</span>);</span><br><span class="line">            outputStream.write(params.getBytes());</span><br><span class="line">            outputStream.flush();</span><br><span class="line">            <span class="comment">//获取网页输出，（得到输入流，把结果得到，再输出到ByteArrayOutputStream内）</span></span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> co.getInputStream();</span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">bout</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> ((len = inputStream.read(bytes)) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                bout.write(bytes, <span class="number">0</span>, len);</span><br><span class="line">            &#125;</span><br><span class="line">            inputStream.close();</span><br><span class="line">            bout.close();</span><br><span class="line">            <span class="comment">//把ByteArrayOutputStream内的东西转换为respBean对象</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(bout.toByteArray());</span><br><span class="line">            <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">            <span class="type">RespBean</span> <span class="variable">respBean</span> <span class="operator">=</span> mapper.readValue(response, RespBean.class);</span><br><span class="line">            <span class="comment">//得到userTicket</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">userTicket</span> <span class="operator">=</span> (String) respBean.getObj();</span><br><span class="line">            System.out.println(<span class="string">&quot;create userTicket&quot;</span> + userTicket);</span><br><span class="line">            <span class="type">String</span> <span class="variable">row</span> <span class="operator">=</span> user.getId() + <span class="string">&quot;,&quot;</span> + userTicket;</span><br><span class="line">            <span class="comment">//写入指定文件</span></span><br><span class="line">            raf.seek(raf.length());</span><br><span class="line">            raf.write(row.getBytes());</span><br><span class="line">            raf.write(<span class="string">&quot;\r\n&quot;</span>.getBytes());</span><br><span class="line">            System.out.println(<span class="string">&quot;write to file:&quot;</span> + user.getId());</span><br><span class="line">        &#125;</span><br><span class="line">        raf.close();</span><br><span class="line">        System.out.println(<span class="string">&quot;over&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Connection <span class="title function_">getConn</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://127.0.0.1:3306/seckill?useSSL=false&amp;useUnicode=false&amp;characterEncoding=UTF-8&amp;serverTimezone=Asia/Shanghai&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> <span class="string">&quot;root&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">&quot;19419&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">driver</span> <span class="operator">=</span> <span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>;</span><br><span class="line">        Class.forName(driver);</span><br><span class="line">        <span class="keyword">return</span> DriverManager.getConnection(url, username, password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        create(<span class="number">2000</span>);<span class="comment">//这里创建了2000个用户.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>使用Jmeter模拟多用户并发请求，发现出现超卖–后续解决</strong></p>
<h2 id="页面优化"><a href="#页面优化" class="headerlink" title="页面优化"></a>页面优化</h2><h3 id="redis页面缓存"><a href="#redis页面缓存" class="headerlink" title="redis页面缓存"></a>redis页面缓存</h3><p><strong>需求说明</strong></p>
<ul>
<li><a href="#xHjJs">在2.1 2.2中</a>， 多用户在查看<strong>商品列表</strong>和<strong>商品详情页</strong>的时候, 每一个用户都需要到DB 查询  </li>
<li>对 DB 查询的压力很大  </li>
<li>但是我们商品信息并不会频繁的变化, 所以你查询回来的结果都是一样的  </li>
<li>我们可以通过 Redis 缓存页面来进行优化, 这样可以将 1 分钟内多次查询DB, 优化成1次查询, 减少 DB 压力</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sazxsdawn2022/picgoimg/duskimg/seckill/img2.png"><br><strong>WebContext就是上下文内容，当作一个常规的用法，知道怎么去使用就行</strong><br>设置过期时间60s</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">	<span class="comment">//进入到商品列表单-改进的到redis中查询</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/toList&quot;, produces = &quot;text/html;charset=utf-8&quot;)</span> <span class="comment">//返回的编码</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toList</span><span class="params">(Model model, User user, HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果redis中有就直接返回，没有的话再继续往下走</span></span><br><span class="line">        <span class="type">ValueOperations</span> <span class="variable">valueOperations</span> <span class="operator">=</span> redisTemplate.opsForValue();</span><br><span class="line">        <span class="type">String</span> <span class="variable">html</span> <span class="operator">=</span> (String) valueOperations.get(<span class="string">&quot;goodsList&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.hasText(html))&#123;</span><br><span class="line">            <span class="keyword">return</span> html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将user放入到model，给下一个模板使用</span></span><br><span class="line">        model.addAttribute(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">        <span class="comment">//将商品列表信息,放入到model,携带该下一个模板使用</span></span><br><span class="line">        model.addAttribute(<span class="string">&quot;goodsList&quot;</span>, goodsService.findGoodsVo());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果从redis中没有获取到页面，就手动渲染然后存到redis中 WebContext就是上下文内容，当作一个常规的用法，知道怎么去使用就行</span></span><br><span class="line">        <span class="comment">//说白了就是把WebContext上下文获取到，并且把model传进去</span></span><br><span class="line">        <span class="type">WebContext</span> <span class="variable">webContext</span> <span class="operator">=</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">WebContext</span>(request, response, request.getServletContext(), request.getLocale(), model.asMap());</span><br><span class="line">        <span class="comment">//处理了一个模板页，取了个名称叫goodsList，内容是从webContext中来的</span></span><br><span class="line">        <span class="comment">//上面没从redis中拿到html，就从这里给html赋值</span></span><br><span class="line">        <span class="comment">//goodsList来自templates中的goodsList.html，之前是走流程渲染的，现在是手动渲染到goodsList.html页面</span></span><br><span class="line">        html = thymeleafViewResolver.getTemplateEngine().process(<span class="string">&quot;goodsList&quot;</span>, webContext);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(StringUtils.hasText(html))&#123;  <span class="comment">//有内容说明渲染成功</span></span><br><span class="line">            <span class="comment">//将页面保存到redis，设置没60秒更新一次，该页面60秒失效，redis会清除这个页面，因为期间页面可能会变化</span></span><br><span class="line">            <span class="comment">//这个goodsList代表在redis中缓存的时候给key取得名称</span></span><br><span class="line">            valueOperations.set(<span class="string">&quot;goodsList&quot;</span>, html, <span class="number">60</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> html;</span><br><span class="line"><span class="comment">//        return &quot;goodsList&quot;;</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//进入商品详情页-根据goodsId</span></span><br><span class="line"><span class="comment">//user是从自定义参数解析器完成带来的</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/toDetail/&#123;goodsId&#125;&quot;, produces = &quot;text/html;charset=utf-8&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">toDetail</span><span class="params">(Model model, User user, <span class="meta">@PathVariable(&quot;goodsId&quot;)</span> Long goodsId,</span></span><br><span class="line"><span class="params">                       HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果redis中有就直接返回，没有的话再继续往下走</span></span><br><span class="line">    <span class="type">ValueOperations</span> <span class="variable">valueOperations</span> <span class="operator">=</span> redisTemplate.opsForValue();</span><br><span class="line">    <span class="type">String</span> <span class="variable">html</span> <span class="operator">=</span> (String) valueOperations.get(<span class="string">&quot;goodsDetail:&quot;</span> + goodsId);</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.hasText(html))&#123;</span><br><span class="line">        <span class="keyword">return</span> html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//放到model中，带给前端页面会用</span></span><br><span class="line">    model.addAttribute(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line"></span><br><span class="line">    <span class="type">GoodsVo</span> <span class="variable">goodsVo</span> <span class="operator">=</span> goodsService.findGoodsVoByGoodsId(goodsId);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;goods&quot;</span>, goodsVo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回秒杀商品详情的同时返回该商品秒杀的状态和秒杀剩余的时间</span></span><br><span class="line">    <span class="comment">//为了配合前端展示秒杀商品的状态 - 这里依然有一个业务设计</span></span><br><span class="line">    <span class="comment">//1. 变量 secKillStatus 秒杀状态 0:秒杀未开始 1: 秒杀进行中 2: 秒杀已经结束</span></span><br><span class="line">    <span class="comment">//2. 变量 remainSeconds 剩余秒数: &gt;0: 表示还有多久开始秒杀: 0: 秒杀进行中 -1: 表示秒杀已经结束</span></span><br><span class="line">    <span class="type">Date</span> <span class="variable">startDate</span> <span class="operator">=</span> goodsVo.getStartDate();</span><br><span class="line">    <span class="type">Date</span> <span class="variable">endDate</span> <span class="operator">=</span> goodsVo.getEndDate();</span><br><span class="line">    <span class="type">Date</span> <span class="variable">nowDate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">    <span class="comment">//秒杀状态</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">secKillStatus</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//秒杀距离开始的剩余时间（单位是秒）</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">remainSeconds</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nowDate.before(startDate)) &#123;</span><br><span class="line">        secKillStatus = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//得到还有多少秒开始秒杀</span></span><br><span class="line">        remainSeconds = (<span class="type">int</span>) ((startDate.getTime() - nowDate.getTime()) / <span class="number">1000</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nowDate.after(endDate)) &#123;</span><br><span class="line">        secKillStatus = <span class="number">2</span>;</span><br><span class="line">        remainSeconds = -<span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        secKillStatus = <span class="number">1</span>;</span><br><span class="line">        remainSeconds = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//将secKillStatus 和 remainSeconds放入到model ,携带给模板页使用</span></span><br><span class="line">    model.addAttribute(<span class="string">&quot;secKillStatus&quot;</span>, secKillStatus);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;remainSeconds&quot;</span>, remainSeconds);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果从redis中没有获取到页面，就手动渲染商品详情页然后存到redis中</span></span><br><span class="line">    <span class="comment">//说白了就是把WebContext上下文获取到，并且把model传进去</span></span><br><span class="line">    <span class="type">WebContext</span> <span class="variable">webContext</span> <span class="operator">=</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">WebContext</span>(request, response, request.getServletContext(), request.getLocale(), model.asMap());</span><br><span class="line">    <span class="comment">//上面没从redis中拿到html，就从这里给html赋值</span></span><br><span class="line">    html = thymeleafViewResolver.getTemplateEngine().process(<span class="string">&quot;goodsDetail&quot;</span>, webContext);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(StringUtils.hasText(html))&#123;  <span class="comment">//有内容说明渲染成功</span></span><br><span class="line">        <span class="comment">//将页面保存到redis，设置没60秒更新一次，该页面60秒失效，redis会清除这个页面，因为期间页面可能会变化</span></span><br><span class="line">        <span class="comment">//这个goodsList代表在redis中缓存的时候给key取得名称</span></span><br><span class="line">        valueOperations.set(<span class="string">&quot;goodsDetail:&quot;</span> + goodsId, html, <span class="number">60</span>, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="对象缓存"><a href="#对象缓存" class="headerlink" title="对象缓存"></a>对象缓存</h3><p><strong>需求说明</strong></p>
<ul>
<li><a href="#uRGjD">1.2.2</a>中当用户登录成功后, 就会将用户对象缓存到 Redis  </li>
<li>好处是解决了分布式架构下的 Session 共享问题  </li>
<li>但是也带来新问题, 如果用户信息改变, DB用户信息和Redis 缓存用户对象不一致问题-也就是对象缓存问题</li>
</ul>
<p><strong>解决思路</strong></p>
<ul>
<li>编写方法, 当用户信息变化时, 就更新用户在 DB 的信息, 同时删除该用户在Redis的缓存对象  </li>
<li>这样用户就需要使用新密码重新登录, 从而更新用户在 Redis 对应的缓存对象</li>
</ul>
<h2 id="复购和超卖"><a href="#复购和超卖" class="headerlink" title="复购和超卖"></a>复购和超卖</h2><h3 id="超卖"><a href="#超卖" class="headerlink" title="超卖"></a>超卖</h3><p><strong>需求说明</strong><br><a href="#fnMe4">解决2.3.3中</a>doSeckill 方法版本1的超卖问题<br><strong>出现超卖问题的原因</strong></p>
<ul>
<li>在SeckillController 中判断复购，库存之后就进入到OrderServiceImpl中的seckill方法进行秒杀</li>
<li>而在高并发下可能同时200个请求同时执行判断库存的语句，都通过了库存判断</li>
<li>然后都冲入到OrderServiceImpl中的seckill方法，而该方法中<strong>减库存的操作不具备原子性</strong></li>
<li>可能多个请求才减去1个商品，而冲到seckill中的请求都会生成订单</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sazxsdawn2022/picgoimg/duskimg/seckill/img3.png" alt="image.png"><br><strong>解决思路</strong></p>
<ul>
<li>Mysql在默认的事务隔离级别（可重复读）下，执行update语句时,会在事务中锁定要更新的行</li>
<li>这可以防止其他会话在同一行上执行 <strong>UPDATE</strong> 或DELETE操作  <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Order <span class="title function_">seckill</span><span class="params">(User user, GoodsVo goodsVo)</span> &#123;</span><br><span class="line">    <span class="comment">//认为能进到这个代码中就是可以秒杀</span></span><br><span class="line">    <span class="comment">//查询秒杀商品的库存,并-1</span></span><br><span class="line">    <span class="type">SeckillGoods</span> <span class="variable">seckillGoods</span> <span class="operator">=</span> seckillGoodsService.</span><br><span class="line">            getOne(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;SeckillGoods&gt;().eq(<span class="string">&quot;goods_id&quot;</span>, goodsVo.getId()));</span><br><span class="line">    <span class="comment">//完成一个基本的秒杀操作[这块不具原子性],后面在高并发的情况下,还会优化, 不用急</span></span><br><span class="line"><span class="comment">//        seckillGoods.setStockCount(seckillGoods.getStockCount() - 1);</span></span><br><span class="line"><span class="comment">//        seckillGoodsService.updateById(seckillGoods);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//1. Mysql在默认的事务隔离级[REPEATABLE-READ]别下</span></span><br><span class="line">    <span class="comment">//2. 执行update语句时,会在事务中锁定要更新的行</span></span><br><span class="line">    <span class="comment">//3. 这样可以防止其它会话在同一行执行update,delete</span></span><br><span class="line">    System.out.println(<span class="string">&quot;执行update==&gt;&quot;</span> + user.getId());</span><br><span class="line">    <span class="comment">//只要在更新成功时,返回true,否则返回false, 即更新后，受影响的行数&gt;=1为T</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">update</span> <span class="operator">=</span> seckillGoodsService.update(<span class="keyword">new</span> <span class="title class_">UpdateWrapper</span>&lt;SeckillGoods&gt;()</span><br><span class="line">            .setSql(<span class="string">&quot;stock_count=stock_count-1&quot;</span>)</span><br><span class="line">            .eq(<span class="string">&quot;goods_id&quot;</span>, goodsVo.getId()).gt(<span class="string">&quot;stock_count&quot;</span>, <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!update) &#123;<span class="comment">//如果更新失败,说明已经没有库存了</span></span><br><span class="line">        <span class="comment">//把这个秒杀失败的信息-记录到Redis</span></span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;seckillFail:&quot;</span> + user.getId() + <span class="string">&quot;:&quot;</span> + goodsVo.getId(), <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//生成普通订单</span></span><br><span class="line">    <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Order</span>();</span><br><span class="line">    order.setUserId(user.getId());</span><br><span class="line">    order.setGoodsId(goodsVo.getId());</span><br><span class="line">    order.setDeliveryAddrId(<span class="number">0L</span>);<span class="comment">//老师就设置一个初始值</span></span><br><span class="line">    order.setGoodsName(goodsVo.getGoodsName());</span><br><span class="line">    order.setGoodsCount(<span class="number">1</span>);</span><br><span class="line">    order.setGoodsPrice(seckillGoods.getSeckillPrice());  <span class="comment">//秒杀的价格</span></span><br><span class="line">    order.setOrderChannel(<span class="number">1</span>);<span class="comment">//老师就设置一个初始值</span></span><br><span class="line">    order.setStatus(<span class="number">0</span>);<span class="comment">//老师就设置一个初始值-未支付</span></span><br><span class="line">    order.setCreateDate(<span class="keyword">new</span> <span class="title class_">Date</span>());<span class="comment">//设置成now</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存order</span></span><br><span class="line">    orderMapper.insert(order);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//生成秒杀商品订单-</span></span><br><span class="line">    <span class="type">SeckillOrder</span> <span class="variable">seckillOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SeckillOrder</span>();</span><br><span class="line">    seckillOrder.setGoodsId(goodsVo.getId());</span><br><span class="line">    <span class="comment">//这里秒杀商品订单对应的order_id 是从上面添加 order后获取到的</span></span><br><span class="line">    seckillOrder.setOrderId(order.getId());</span><br><span class="line">    seckillOrder.setUserId(user.getId());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存seckillOrder 用mapper也行</span></span><br><span class="line">    seckillOrderService.save(seckillOrder);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将生成的秒杀订单，存入到Redis, 这样在查询某个用户是否已经秒杀了这个商品时，</span></span><br><span class="line">    <span class="comment">//直接到Redis中查询，起到优化效果</span></span><br><span class="line">    <span class="comment">//设计秒杀订单的key =&gt; order:用户id:商品id</span></span><br><span class="line">    redisTemplate.opsForValue().set(<span class="string">&quot;order:&quot;</span> + user.getId() + <span class="string">&quot;:&quot;</span> + goodsVo.getId(), seckillOrder);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> order;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
使用update代替下面原来减库存的语句（Mybatis-plus）<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeckillGoodsServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;SeckillGoodsMapper, SeckillGoods&gt;</span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">SeckillGoodsService</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="variable">update</span> <span class="operator">=</span> seckillGoodsService.update(<span class="keyword">new</span> <span class="title class_">UpdateWrapper</span>&lt;SeckillGoods&gt;()</span><br><span class="line">                .setSql(<span class="string">&quot;stock_count=stock_count-1&quot;</span>)</span><br><span class="line">                .eq(<span class="string">&quot;goods_id&quot;</span>, goodsVo.getId()).gt(<span class="string">&quot;stock_count&quot;</span>, <span class="number">0</span>));</span><br></pre></td></tr></table></figure>
这样减库存的操作就是串行执行的了，库存小于1会更新失败，也不会生成订单了<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!update) &#123;</span><br><span class="line">    <span class="comment">//如果更新失败,说明已经没有库存了，把这个秒杀失败的信息-记录到Redis</span></span><br><span class="line">    redisTemplate.opsForValue()</span><br><span class="line">    .set(<span class="string">&quot;seckillFail:&quot;</span> + user.getId() + <span class="string">&quot;:&quot;</span> + goodsVo.getId(), <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
当然了，这样解决仍有大量的请求进入seckill然后到DB中执行sql，后面会优化</li>
</ul>
<h3 id="复购"><a href="#复购" class="headerlink" title="复购"></a>复购</h3><p><strong>需求说明</strong></p>
<ul>
<li><a href="#fnMe4">对版本1进行优化</a>，不去数据库看是否存在该用户对此商品的秒杀订单</li>
<li>而是把生成的订单放到redis中，后面直接从redis中判断是否复购</li>
<li>就是seckill最后生成秒杀订单后设置到redis中</li>
</ul>
<h2 id="秒杀优化"><a href="#秒杀优化" class="headerlink" title="秒杀优化"></a>秒杀优化</h2><h3 id="预减库存-Decrement"><a href="#预减库存-Decrement" class="headerlink" title="预减库存+Decrement"></a>预减库存+Decrement</h3><p><strong>目的就是减少去到数据库中的操作</strong><br><strong>需求说明</strong></p>
<ul>
<li><a href="#fnMe4">在2.3.3中</a>防止超卖，SeckillController 是直接到数据库查出商品的 goodsService.findGoodsVoByGoodsId(goodsId);    初步判断的库存，并发下不准确</li>
<li>大量的并发请求都去<strong>到数据库中尝试减库存的操作</strong>，虽然控制了超卖，但容易把数据库压垮</li>
</ul>
<p><strong>解决思路</strong></p>
<ul>
<li>使用 Redis 完成<strong>预减库存</strong>，如果没有库存了, 直接返回, 减小对DB的压力  </li>
<li><strong>如果预减库存后，库存小于0就不再去orderService.seckill()中了</strong></li>
<li><strong>结果就是库存有多少就进去几个请求</strong></li>
<li><strong>依赖decrement具有原子性</strong>，redisTemplate.opsForValue().<strong>decrement(“seckillGoods:” + goodsId);</strong><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//库存预减, 如果在Redis中预减库存，发现秒杀商品已经没有了，就直接返回</span></span><br><span class="line"><span class="comment">//从而减少去执行 orderService.seckill() 请求,防止线程堆积, 优化秒杀/高并发</span></span><br><span class="line"><span class="comment">// decrement()是具有原子性!!</span></span><br><span class="line"><span class="type">Long</span> <span class="variable">decrement</span> <span class="operator">=</span> redisTemplate.opsForValue().decrement(<span class="string">&quot;seckillGoods:&quot;</span> + goodsId);</span><br><span class="line"><span class="keyword">if</span> (decrement &lt; <span class="number">0</span>) &#123;<span class="comment">//说明这个商品已经没有库存</span></span><br><span class="line">    <span class="comment">//恢复库存为0</span></span><br><span class="line">    redisTemplate.opsForValue().increment(<span class="string">&quot;seckillGoods:&quot;</span> + goodsId);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;errmsg&quot;</span>, RespBeanEnum.ENTRY_STOCK.getMessage());</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;secKillFail&quot;</span>;<span class="comment">//错误页面</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
**前奏：SeckillController的初始化方法，从数据库查出所有的秒杀商品，然后存到redis中 seckillGoods : id **<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//这个方法是在类的所有属性，都初始化后，自动执行的</span></span><br><span class="line"><span class="comment">//这里把所有秒杀商品的库存量加载到redis</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">//查询所有的秒杀商品</span></span><br><span class="line">    List&lt;GoodsVo&gt; list = goodsService.findGoodsVo();</span><br><span class="line">    <span class="keyword">if</span> (CollectionUtils.isEmpty(list)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//遍历List，然后将秒杀商品的库存量放入到redis</span></span><br><span class="line">    <span class="comment">//秒杀商品库存量对应key: seckillGoods:商品id</span></span><br><span class="line">    list.forEach(goodsVo -&gt; &#123;</span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;seckillGoods:&quot;</span> + goodsVo.getId(), goodsVo.getStockCount());</span><br><span class="line">        <span class="comment">//初始化map</span></span><br><span class="line">        <span class="comment">//如果goodsId : false 表示有库存</span></span><br><span class="line">        <span class="comment">//如果goodsId : true 表示没有库存</span></span><br><span class="line">        entryStockMap.put(goodsVo.getId(), <span class="literal">false</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="加入内存标记"><a href="#加入内存标记" class="headerlink" title="加入内存标记"></a>加入内存标记</h3><p><strong>目的就是减少到redis中预减库存</strong><br><strong>需求说明</strong></p>
<ul>
<li>如果某个商品库存已经为空了，我们仍然是到 Redis 去查询的，还可以进行优化  </li>
<li>给商品进行内存标记，如果库存为空，直接返回，避免总是到Redis 查询库存</li>
</ul>
<p><strong>解决思路</strong><br><strong>操作本机JVM快于操作Redis</strong><br><strong>添加属性    private HashMap&lt;Long, Boolean&gt; entryStockMap &#x3D; new HashMap&lt;&gt;();</strong></p>
<ul>
<li>在到redis中预减库存之前，先查看entryStockMap，如果标记为true，则表示redis中的库存已经为0</li>
<li>不再去redis中预减</li>
<li>如果是redis中库存<strong>第一次</strong>不足，预减后设置标记为true<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//处理用户抢购请求/秒杀</span></span><br><span class="line"><span class="comment">//说明：我们先完成一个V4.0版本，加入内存标记优化秒杀</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/doSeckill&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">doSeckill</span><span class="params">(Model model, User user, Long goodsId)</span> &#123;</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;------秒杀V4.0 开始-------&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    model.addAttribute(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">    </span><br><span class="line">    <span class="type">GoodsVo</span> <span class="variable">goodsVo</span> <span class="operator">=</span> goodsService.findGoodsVoByGoodsId(goodsId);</span><br><span class="line">    <span class="comment">//判断库存</span></span><br><span class="line">    <span class="keyword">if</span> (goodsVo.getStockCount() &lt; <span class="number">1</span>) &#123;<span class="comment">//没有库存</span></span><br><span class="line">        model.addAttribute(<span class="string">&quot;errmsg&quot;</span>, RespBeanEnum.ENTRY_STOCK.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;secKillFail&quot;</span>;<span class="comment">//错误页面</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断用户是否复购</span></span><br><span class="line">    <span class="type">SeckillOrder</span> <span class="variable">seckillOrder</span> <span class="operator">=</span> (SeckillOrder) redisTemplate.opsForValue().get(<span class="string">&quot;order:&quot;</span> + user.getId() + <span class="string">&quot;:&quot;</span> + goodsId);</span><br><span class="line">    <span class="keyword">if</span> (seckillOrder != <span class="literal">null</span>) &#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;errmsg&quot;</span>, RespBeanEnum.REPEAT_ERROR.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;secKillFail&quot;</span>;<span class="comment">//错误页面</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//对map进行判断[内存标记],如果商品在map已经标记为没有库存，则直接返回，无需进行Redis预减</span></span><br><span class="line">    <span class="keyword">if</span> (entryStockMap.get(goodsId)) &#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;errmsg&quot;</span>, RespBeanEnum.ENTRY_STOCK.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;secKillFail&quot;</span>;<span class="comment">//错误页面</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//库存预减, 如果在Redis中预减库存，发现秒杀商品已经没有了，就直接返回</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">decrement</span> <span class="operator">=</span> redisTemplate.opsForValue().decrement(<span class="string">&quot;seckillGoods:&quot;</span> + goodsId);</span><br><span class="line">    <span class="keyword">if</span> (decrement &lt; <span class="number">0</span>) &#123;<span class="comment">//说明这个商品已经没有库存</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//就是在这设置了内存标记之后，相当于直接告诉后来的请求说已经没有库存了，不用再去redis中预减了。截断的效果</span></span><br><span class="line">        entryStockMap.put(goodsId, <span class="literal">true</span>);  <span class="comment">//定义的true是代表没有库存了</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//恢复库存为0</span></span><br><span class="line">        redisTemplate.opsForValue().increment(<span class="string">&quot;seckillGoods:&quot;</span> + goodsId);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;errmsg&quot;</span>, RespBeanEnum.ENTRY_STOCK.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;secKillFail&quot;</span>;<span class="comment">//错误页面</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//抢购</span></span><br><span class="line">    <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderService.seckill(user, goodsVo);</span><br><span class="line">    <span class="keyword">if</span> (order == <span class="literal">null</span>) &#123; <span class="comment">//有可能执行过程中出错</span></span><br><span class="line">        model.addAttribute(<span class="string">&quot;errmsg&quot;</span>, RespBeanEnum.ENTRY_STOCK.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;secKillFail&quot;</span>;<span class="comment">//错误页面</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//进入到订单页</span></span><br><span class="line">    model.addAttribute(<span class="string">&quot;order&quot;</span>, order);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;goods&quot;</span>, goodsVo);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;------秒杀V4.0 结束-------&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;orderDetail&quot;</span>; <span class="comment">//进入订单详情页</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="加入消息队列，秒杀异步请求"><a href="#加入消息队列，秒杀异步请求" class="headerlink" title="加入消息队列，秒杀异步请求"></a>加入消息队列，秒杀异步请求</h3><p><strong>目的是把执行seckill交给消息队列，赶紧返回客户端消息，防止线程堆积</strong><br><strong>需求说明</strong></p>
<ul>
<li>前面秒杀, 没有实现异步机制, 是<strong>完成下订单后, 再返回</strong>的</li>
<li>当有大并发请求下订单操作时, 数据库来不及响应, 容易造成<strong>线程堆积</strong></li>
</ul>
<p><strong>解决思路</strong></p>
<ul>
<li>加入消息队列，实现秒杀的异步请求  </li>
<li>接收到客户端秒杀请求后，<strong>服务器立即返回 正在秒杀中..</strong>, 有利于流量削峰  </li>
<li>客户端进行轮询秒杀结果, 接收到秒杀结果后，在客户端页面显示即可</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sazxsdawn2022/picgoimg/duskimg/seckill/img4.png" alt="秒杀加入消息队列逻辑"><br><strong>使用的是RabbotMQ的Topic主题模式</strong>（Direct路由模式下的一种扩展）<br>把秒杀操作seckill移到消息消费者，然后消费者执行</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SeckillMessage: 秒杀消息对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeckillMessage</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> User user;</span><br><span class="line">    <span class="keyword">private</span> Long goodsId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>秒杀消息组成：</p>
<ul>
<li>用户 user</li>
<li>商品id goodsId<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * RabbitMQSeckillConfig: 配置类，创建消息队列和交换机</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQSeckillConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义消息队列名和交换机名</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE</span> <span class="operator">=</span> <span class="string">&quot;seckillQueue&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;seckillExchange&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建队列</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">queue_seckill</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(QUEUE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建交换机-Topic</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TopicExchange <span class="title function_">topicExchange_seckill</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TopicExchange</span>(EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将队列绑定到交换机，并指定路由</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">binding_seckill</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue_seckill())</span><br><span class="line">        		.to(topicExchange_seckill()).with(<span class="string">&quot;seckill.#&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * MQSenderMessage: 消息的生产者/发送者[秒杀消息]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MQSenderMessage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//装配RabbitTemplate</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//方法：发送秒杀消息</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendSeckillMessage</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;发送消息--&gt;&quot;</span> + message);</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;seckillExchange&quot;</span>, <span class="string">&quot;seckill.message&quot;</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
发送的是String<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * MQReceiverMessage: 消息的接收者/消费者, 这里调用seckill方法()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MQReceiverMessage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//装配需要的组件/对象</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> GoodsService goodsService;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//接收消息，并完成下单</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;seckillQueue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queue</span><span class="params">(String message)</span> &#123;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;接收到的消息是--&gt;&quot;</span> + message);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//解读，这里我们从队列中取出的是string</span></span><br><span class="line">        <span class="comment">//但是我们需要的是SeckillMessage, 因此需要一个工具类JSONUtil</span></span><br><span class="line">        <span class="comment">//在hutool依赖</span></span><br><span class="line">        <span class="type">SeckillMessage</span> <span class="variable">seckillMessage</span> <span class="operator">=</span></span><br><span class="line">                JSONUtil.toBean(message, SeckillMessage.class);</span><br><span class="line">        <span class="comment">//秒杀用户对象</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> seckillMessage.getUser();</span><br><span class="line">        <span class="comment">//秒杀的商品id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">goodsId</span> <span class="operator">=</span> seckillMessage.getGoodsId();</span><br><span class="line">        <span class="comment">//通过商品id,得到对应的GoodsVo</span></span><br><span class="line">        <span class="type">GoodsVo</span> <span class="variable">goodsVo</span> <span class="operator">=</span> goodsService.findGoodsVoByGoodsId(goodsId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//下单操作</span></span><br><span class="line">        orderService.seckill(user, goodsVo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
用工具类JSONUtil把String转为SeckillMessage<br>SeckillController 中抢购的代码变化<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//抢购</span></span><br><span class="line"><span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderService.seckill(user, goodsVo);</span><br><span class="line"><span class="keyword">if</span> (order == <span class="literal">null</span>) &#123; <span class="comment">//有可能执行过程中出错</span></span><br><span class="line">    model.addAttribute(<span class="string">&quot;errmsg&quot;</span>, RespBeanEnum.ENTRY_STOCK.getMessage());</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;secKillFail&quot;</span>;<span class="comment">//错误页面</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//抢购,向消息队列发送秒杀请求,实现了秒杀异步请求</span></span><br><span class="line"><span class="comment">//这里我们发送秒杀消息后，立即快速返回结果[临时结果] - &quot;比如排队中..&quot;</span></span><br><span class="line"><span class="comment">//客户端可以通过轮询，获取到最终结果</span></span><br><span class="line"><span class="comment">//创建SeckillMessage</span></span><br><span class="line"><span class="type">SeckillMessage</span> <span class="variable">seckillMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SeckillMessage</span>(user, goodsId);</span><br><span class="line">mqSenderMessage.sendSeckillMessage(JSONUtil.toJsonStr(seckillMessage));</span><br><span class="line">model.addAttribute(<span class="string">&quot;errmsg&quot;</span>, <span class="string">&quot;排队中...&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;secKillFail&quot;</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="秒杀安全"><a href="#秒杀安全" class="headerlink" title="秒杀安全"></a>秒杀安全</h2><h3 id="秒杀接口地址隐藏"><a href="#秒杀接口地址隐藏" class="headerlink" title="秒杀接口地址隐藏"></a>秒杀接口地址隐藏</h3><p><strong>需求说明</strong></p>
<ul>
<li>前面我们处理高并发, 是按照正常业务逻辑处理的, 也就是用户正常抢购  </li>
<li>还需要考虑抢购安全性, 当前程序, <strong>抢购接口是固定, 如果泄露, 会有安全隐患</strong>, 比如抢购未开始或者已结束, 还可以使用脚本发起抢购</li>
</ul>
<p><strong>解决思路</strong></p>
<ul>
<li>隐藏抢购接口  </li>
<li>用户抢购时, 先<strong>生成一个唯一的抢购路径, 返回给客户端</strong>  </li>
<li>客户端抢购时会携带生成的抢购路径, <strong>服务端做校验</strong>, 如果校验成功, 才走下一步, 否则直接返回</li>
</ul>
<p><strong>解决过程</strong><br><img src="https://cdn.jsdelivr.net/gh/sazxsdawn2022/picgoimg/duskimg/seckill/img5.png" alt="image.png"><br><strong>OrderServiceImpl生成的秒杀路径放到redis中，便于后面到redis中校验</strong><br>set(“<strong>seckillPath:”+ user.getId() + “:” + goodsId</strong>，<strong>path</strong>, 60, TimeUnit.SECONDS);</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//方法: 生成秒杀路径/值(唯一)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">createPath</span><span class="params">(User user, Long goodsId)</span> &#123;</span><br><span class="line">    <span class="comment">//生成秒杀路径/值</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> MD5Util.md5(UUIDUtil.uuid());</span><br><span class="line">    <span class="comment">//将随机生成的路径保存到Redis, 设置一个超时时间60s</span></span><br><span class="line">    <span class="comment">//key的设计: seckillPath:userId:goodsId</span></span><br><span class="line">    redisTemplate.opsForValue().set(<span class="string">&quot;seckillPath:&quot;</span>+ user.getId() + <span class="string">&quot;:&quot;</span> + goodsId,</span><br><span class="line">            path, <span class="number">60</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">return</span> path;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//方法: 对秒杀路径进行校验</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">checkPath</span><span class="params">(User user, Long goodsId, String path)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span> || goodsId &lt; <span class="number">0</span> || !StringUtils.hasText(path)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//取出该用户秒杀该商品的路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">redisPath</span> <span class="operator">=</span> (String) redisTemplate.opsForValue()</span><br><span class="line">                        .get(<span class="string">&quot;seckillPath:&quot;</span> + user.getId() + <span class="string">&quot;:&quot;</span> + goodsId);</span><br><span class="line">    <span class="keyword">return</span> path.equals(redisPath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>在OrderController中增加getPath，createPath后返回给客户端</strong><br>然后客户端带着新路径再次发出秒杀请求</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//方法：获取秒杀路径</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/path&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@AccessLimit(second = 5, maxCount = 5, needLogin = true)</span></span><br><span class="line"><span class="keyword">public</span> RespBean <span class="title function_">getPath</span><span class="params">(User user, Long goodsId, String captcha, HttpServletRequest request)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span> || goodsId &lt; <span class="number">0</span> || !StringUtils.hasText(captcha)) &#123;</span><br><span class="line">        <span class="keyword">return</span> RespBean.error(RespBeanEnum.SESSION_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> orderService.createPath(user, goodsId);</span><br><span class="line">    <span class="keyword">return</span> RespBean.success(path);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>在SeckillController做地址校验，路径正确了再忘下一步走</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//处理用户抢购请求/秒杀</span></span><br><span class="line"><span class="comment">//说明：我们先完成一个V6.0版本，加入秒杀安全，直接返回RespBean，不再去下一个页面了</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/&#123;path&#125;/doSeckill&quot;)</span>  <span class="comment">//每一个秒杀的路径都不一样</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> RespBean <span class="title function_">doSeckill</span><span class="params">(<span class="meta">@PathVariable</span> String path, Model model, User user, Long goodsId)</span> &#123;</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;------秒杀V6.0 开始-------&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;<span class="comment">//用户没有登录</span></span><br><span class="line">        <span class="keyword">return</span> RespBean.error(RespBeanEnum.SESSION_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这里增加一个逻辑，校验用户携带的path是否正确</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">checkPath</span> <span class="operator">=</span> orderService.checkPath(user, goodsId, path);</span><br><span class="line">    <span class="keyword">if</span>(!checkPath)&#123;</span><br><span class="line">        <span class="keyword">return</span> RespBean.error(RespBeanEnum.REQUEST_ILLEGAL);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="验证码防止脚本攻击"><a href="#验证码防止脚本攻击" class="headerlink" title="验证码防止脚本攻击"></a>验证码防止脚本攻击</h3><p><strong>需求说明</strong></p>
<ul>
<li>在一些抢购活动中, 可以通过验证码的方式, 防止脚本攻击, 比如12306</li>
</ul>
<p><strong>解决思路</strong></p>
<ul>
<li>使用验证码 happyCaptcha  ![image.png.&#x2F;.&#x2F;duskimg&#x2F;seckill&#x2F;img6.png)</li>
</ul>
<p><strong>解决过程</strong><br><strong>在SeckillController中增加方法生成验证码，保存到reids，便于后面校验</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//生成验证码-happyCaptcha</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/captcha&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">happyCaptcha</span><span class="params">(HttpServletRequest request, HttpServletResponse response, User user, Long goodsId)</span> &#123;</span><br><span class="line">    <span class="comment">//生成验证码，并输出</span></span><br><span class="line">    <span class="comment">//注意，该验证码，默认就保存到session中, key是 happy-captcha</span></span><br><span class="line">    HappyCaptcha.require(request, response)</span><br><span class="line">            .style(CaptchaStyle.ANIM)               <span class="comment">//设置展现样式为动画</span></span><br><span class="line">            .type(CaptchaType.NUMBER)               <span class="comment">//设置验证码内容为数字</span></span><br><span class="line">            .length(<span class="number">6</span>)                              <span class="comment">//设置字符长度为6</span></span><br><span class="line">            .width(<span class="number">220</span>)                             <span class="comment">//设置动画宽度为220</span></span><br><span class="line">            .height(<span class="number">80</span>)                             <span class="comment">//设置动画高度为80</span></span><br><span class="line">            .font(Fonts.getInstance().zhFont())     <span class="comment">//设置汉字的字体</span></span><br><span class="line">            .build().finish();                      <span class="comment">//生成并输出验证码</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//把验证码的值，保存Redis [考虑项目分布式], 设置了验证码的失效时间100s</span></span><br><span class="line">    <span class="comment">//key: captcha:userId:goodsId</span></span><br><span class="line">    redisTemplate.opsForValue().set(<span class="string">&quot;captcha:&quot;</span> + user.getId() + <span class="string">&quot;:&quot;</span> + goodsId</span><br><span class="line">            , (String) request.getSession().getAttribute(<span class="string">&quot;happy-captcha&quot;</span>), <span class="number">100</span>, TimeUnit.SECONDS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>在OrderServiceImpl中增加校验验证码的方法</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//方法: 验证用户输入的验证码是否正确</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">checkCaptcha</span><span class="params">(User user, Long goodsId, String captcha)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span> || goodsId &lt; <span class="number">0</span> || !StringUtils.hasText(captcha)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从Redis取出验证码</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">redisCaptcha</span> <span class="operator">=</span> (String) redisTemplate.opsForValue().get(<span class="string">&quot;captcha:&quot;</span> + user.getId() + <span class="string">&quot;:&quot;</span> + goodsId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> captcha.equals(redisCaptcha);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="秒杀接口限流-防刷"><a href="#秒杀接口限流-防刷" class="headerlink" title="秒杀接口限流-防刷"></a>秒杀接口限流-防刷</h3><p><strong>需求说明</strong></p>
<ul>
<li>完成接口限流-防止某个用户频繁的请求秒杀接口  </li>
<li>比如在短时间内，频繁点击立即秒杀</li>
</ul>
<p><strong>解决思路</strong><br><img src="https://cdn.jsdelivr.net/gh/sazxsdawn2022/picgoimg/duskimg/seckill/img7.png" alt="image.png"><br><strong>解决过程</strong></p>
<h4 id="简单接口限流"><a href="#简单接口限流" class="headerlink" title="简单接口限流"></a>简单接口限流</h4><ul>
<li>使用简单的 Redis 计数器, 完成接口限流防刷 </li>
<li>除了计数器算法，也有其它的算法来进行接口限流, 比如漏桶算法和令牌桶算法  </li>
<li>添加在获取路径代码之前<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//增加业务逻辑: 加入Redis计数器, 完成对用户的限流防刷</span></span><br><span class="line"><span class="comment">//比如:5秒内访问次数超过了5次, 我们就认为是刷接口</span></span><br><span class="line"><span class="comment">//这里先把代码写在方法中，后面我们使用注解提高使用的通用性</span></span><br><span class="line"><span class="comment">//uri就是 localhost:8080/seckill/path 的 /seckill/path</span></span><br><span class="line"><span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> request.getRequestURI();</span><br><span class="line"><span class="type">ValueOperations</span> <span class="variable">valueOperations</span> <span class="operator">=</span> redisTemplate.opsForValue();</span><br><span class="line"><span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> uri + <span class="string">&quot;:&quot;</span> + user.getId();</span><br><span class="line"><span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> (Integer) valueOperations.get(key);</span><br><span class="line"><span class="keyword">if</span> (count == <span class="literal">null</span>) &#123;<span class="comment">//说明还没有key,就初始化，值为1, 过期时间为5秒</span></span><br><span class="line">    valueOperations.set(key, <span class="number">1</span>, <span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (count &lt; <span class="number">5</span>) &#123;<span class="comment">//说明正常访问</span></span><br><span class="line">    valueOperations.increment(key);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;<span class="comment">//说明用户在刷接口</span></span><br><span class="line">    <span class="keyword">return</span> RespBean.error(RespBeanEnum.ACCESS_LIMIT_REACHED);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="通过接口限流"><a href="#通过接口限流" class="headerlink" title="通过接口限流"></a>通过接口限流</h4><ul>
<li>自定义注解@AccessLimit, 提高接口限流功能通用性 , 减少冗余代码, 同时也减少业务代码入侵</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/sazxsdawn2022/picgoimg/duskimg/seckill/img8.png" alt="image.png"><br>自定义注解@AccessLimit，时间范围，访问最大次数，是否登录</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * AccessLimit: 自定义的注解</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AccessLimit &#123;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">second</span><span class="params">()</span>;<span class="comment">//时间范围</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">maxCount</span><span class="params">()</span>;<span class="comment">//访问的最大次数</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">needLogin</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>;<span class="comment">//是否登录</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>写到getPath方法里</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//方法：获取秒杀路径</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/path&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@AccessLimit</span>(second = 5,maxCount = 5,needLogin = true)</span></span><br><span class="line"><span class="comment"> * 1. 使用注解的方式完成对用户的限流防刷-通用性和灵活性提高</span></span><br><span class="line"><span class="comment"> * 2. second = 5,maxCount = 5 说明是在5秒内可以访问的最大次数是5次</span></span><br><span class="line"><span class="comment"> * 3. needLogin = true 表示用户是否需要登录</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@AccessLimit(second = 5, maxCount = 5, needLogin = true)</span></span><br><span class="line"><span class="keyword">public</span> RespBean <span class="title function_">getPath</span><span class="params">(User user, Long goodsId, String captcha, HttpServletRequest request)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span> || goodsId &lt; <span class="number">0</span> || !StringUtils.hasText(captcha)) &#123;</span><br><span class="line">        <span class="keyword">return</span> RespBean.error(RespBeanEnum.SESSION_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//        //增加业务逻辑: 加入Redis计数器, 完成对用户的限流防刷</span></span><br><span class="line"><span class="comment">//        //比如:5秒内访问次数超过了5次, 我们就认为是刷接口</span></span><br><span class="line"><span class="comment">//        //这里先把代码写在方法中，后面我们使用注解提高使用的通用性</span></span><br><span class="line"><span class="comment">//        //uri就是 localhost:8080/seckill/path 的 /seckill/path</span></span><br><span class="line"><span class="comment">//        String uri = request.getRequestURI();</span></span><br><span class="line"><span class="comment">//        ValueOperations valueOperations = redisTemplate.opsForValue();</span></span><br><span class="line"><span class="comment">//        String key = uri + &quot;:&quot; + user.getId();</span></span><br><span class="line"><span class="comment">//        Integer count = (Integer) valueOperations.get(key);</span></span><br><span class="line"><span class="comment">//        if (count == null) &#123;//说明还没有key,就初始化，值为1, 过期时间为5秒</span></span><br><span class="line"><span class="comment">//            valueOperations.set(key, 1, 5, TimeUnit.SECONDS);</span></span><br><span class="line"><span class="comment">//        &#125; else if (count &lt; 5) &#123;//说明正常访问</span></span><br><span class="line"><span class="comment">//            valueOperations.increment(key);</span></span><br><span class="line"><span class="comment">//        &#125; else &#123;//说明用户在刷接口</span></span><br><span class="line"><span class="comment">//            return RespBean.error(RespBeanEnum.ACCESS_LIMIT_REACHED);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//增加一个业务逻辑-校验用户输入的验证码是否正确</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">check</span> <span class="operator">=</span> orderService.checkCaptcha(user, goodsId, captcha);</span><br><span class="line">    <span class="keyword">if</span> (!check) &#123;<span class="comment">//如果校验失败</span></span><br><span class="line">        <span class="keyword">return</span> RespBean.error(RespBeanEnum.CAPTCHA_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> orderService.createPath(user, goodsId);</span><br><span class="line">    <span class="keyword">return</span> RespBean.success(path);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//用来存储拦截器获取的 user 对象</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserContext</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//每个线程都有自己的ThreadLocal, 把共享数据存放到这里，保证线程安全</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;User&gt; userHolder = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setUser</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        userHolder.set(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> User <span class="title function_">getUser</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userHolder.get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>属实看不懂这个拦截器</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * AccessLimitInterceptor: 自定义的拦截器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccessLimitInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//装配需要的组件/对象</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这个方法完成1. 得到user对象，并放入到ThreadLoacl 2. 去处理@Accesslimit</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (handler <span class="keyword">instanceof</span> HandlerMethod) &#123;</span><br><span class="line">            <span class="comment">//这里我们就先获取到登录的user对象</span></span><br><span class="line">            <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> getUser(request, response);</span><br><span class="line">            <span class="comment">//存入到ThreadLocal</span></span><br><span class="line">            UserContext.setUser(user);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//把handler 转成 HandlerMethod</span></span><br><span class="line">            <span class="type">HandlerMethod</span> <span class="variable">hm</span> <span class="operator">=</span> (HandlerMethod) handler;</span><br><span class="line">            <span class="comment">//获取到目标方法的注解</span></span><br><span class="line">            <span class="type">AccessLimit</span> <span class="variable">accessLimit</span> <span class="operator">=</span> hm.getMethodAnnotation(AccessLimit.class);</span><br><span class="line">            <span class="keyword">if</span> (accessLimit == <span class="literal">null</span>) &#123;<span class="comment">//如果目标方法没有@AccessLimit说明该接口并没有处理限流防刷</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">//继续</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//获取注解的值</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">second</span> <span class="operator">=</span> accessLimit.second();<span class="comment">//获取到时间范围</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">maxCount</span> <span class="operator">=</span> accessLimit.maxCount();<span class="comment">//获取到最大的访问次数</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">needLogin</span> <span class="operator">=</span> accessLimit.needLogin();<span class="comment">//获取是否需要登录</span></span><br><span class="line">            <span class="keyword">if</span> (needLogin) &#123;<span class="comment">//说明用户必须登录才能访问目标方法/接口</span></span><br><span class="line">                <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;<span class="comment">//说明用户没有登录</span></span><br><span class="line">                    <span class="comment">//返回一个用户信息错误的提示...一会再单独处理...</span></span><br><span class="line">                    render(response, RespBeanEnum.SESSION_ERROR);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;<span class="comment">//返回</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> request.getRequestURI();</span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> uri + <span class="string">&quot;:&quot;</span> + user.getId();</span><br><span class="line">            <span class="type">ValueOperations</span> <span class="variable">valueOperations</span> <span class="operator">=</span> redisTemplate.opsForValue();</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> (Integer) valueOperations.get(key);</span><br><span class="line">            <span class="keyword">if</span> (count == <span class="literal">null</span>) &#123;<span class="comment">//说明还没有key,就初始化，值为1, 过期时间为5秒</span></span><br><span class="line">                valueOperations.set(key, <span class="number">1</span>, second, TimeUnit.SECONDS);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (count &lt; maxCount) &#123;<span class="comment">//说明正常访问</span></span><br><span class="line">                valueOperations.increment(key);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;<span class="comment">//说明用户在刷接口</span></span><br><span class="line">                <span class="comment">//返回一个频繁访问的的提示...一会再单独处理...</span></span><br><span class="line">                render(response,RespBeanEnum.ACCESS_LIMIT_REACHED);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;<span class="comment">//返回</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//方法：构建返回对象-以流的形式返回</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">render</span><span class="params">(HttpServletResponse response,</span></span><br><span class="line"><span class="params">                        RespBeanEnum respBeanEnum)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">        response.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">        <span class="comment">//构建RespBean</span></span><br><span class="line">        <span class="type">RespBean</span> <span class="variable">error</span> <span class="operator">=</span> RespBean.error(respBeanEnum);</span><br><span class="line">        out.write(<span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(error));</span><br><span class="line">        out.flush();</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//单独编写方法，得到登录的user对象-userTicket</span></span><br><span class="line">    <span class="keyword">private</span> User <span class="title function_">getUser</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">ticket</span> <span class="operator">=</span> CookieUtil.getCookieValue(request, <span class="string">&quot;userTicket&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(ticket)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;<span class="comment">//说明该用户没有登录，直接返回null</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> userService.getUserByCookie(ticket, request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//装配</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserArgumentResolver userArgumentResolver;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AccessLimitInterceptor accessLimitInterceptor;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//    注册自定义拦截器，这样就可以生效</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(accessLimitInterceptor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//静态资源加载</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span> &#123;</span><br><span class="line">        registry.addResourceHandler(<span class="string">&quot;/**&quot;</span>).addResourceLocations(<span class="string">&quot;classpath:/static/&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这里加入我们自定义的解析器到 HandlerMethodArgumentResolver列表中</span></span><br><span class="line">    <span class="comment">//这样自定义的解析器工作</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addArgumentResolvers</span><span class="params">(List&lt;HandlerMethodArgumentResolver&gt; resolvers)</span> &#123;</span><br><span class="line">        resolvers.add(userArgumentResolver);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * UserArgumentResolver: 自定义的一个解析器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserArgumentResolver</span> <span class="keyword">implements</span> <span class="title class_">HandlerMethodArgumentResolver</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//装配UserService</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断你当前要解析的参数类型是不是你需要的?</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supportsParameter</span><span class="params">(MethodParameter parameter)</span> &#123;</span><br><span class="line">        <span class="comment">//获取参数是不是user类型</span></span><br><span class="line">        Class&lt;?&gt; aClass = parameter.getParameterType();</span><br><span class="line">        <span class="comment">//如果为t, 就执行resolveArgument</span></span><br><span class="line">        <span class="keyword">return</span> aClass == User.class;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果上面supportsParameter,返回T,就执行下面的resolveArgument方法</span></span><br><span class="line">    <span class="comment">//到底怎么解析，是由程序员根据业务来编写</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">resolveArgument</span><span class="params">(MethodParameter parameter, ModelAndViewContainer mavContainer, NativeWebRequest webRequest, WebDataBinderFactory binderFactory)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//        HttpServletRequest request = webRequest.getNativeRequest(HttpServletRequest.class);</span></span><br><span class="line"><span class="comment">//        HttpServletResponse response = webRequest.getNativeResponse(HttpServletResponse.class);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        String ticket = CookieUtil.getCookieValue(request, &quot;userTicket&quot;);</span></span><br><span class="line"><span class="comment">//        if (!StringUtils.hasText(ticket)) &#123;</span></span><br><span class="line"><span class="comment">//            return null;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//        //从Redis来获取用户</span></span><br><span class="line"><span class="comment">//        User user = userService.getUserByCookie(ticket, request, response);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        return user;</span></span><br><span class="line">        <span class="keyword">return</span> UserContext.getUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://sazxsdawn2022.github.io">Daggry</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://sazxsdawn2022.github.io/archives/3c7f8ec3.html">http://sazxsdawn2022.github.io/archives/3c7f8ec3.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://sazxsdawn2022.github.io" target="_blank">Daggry House</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%A7%92%E6%9D%80/">秒杀</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/sazxsdawn2022/picgoimg/duskimg/seckill/seckill.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/archives/8b544b71.html" title="Redis为什么这么快"><img class="cover" src="https://cdn.jsdelivr.net/gh/sazxsdawn2022/picgoimg/duskimg/tec/hah01.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Redis为什么这么快</div></div></a></div><div class="next-post pull-right"><a href="/archives/ae991c2b.html" title="Component 和 @Configuration 的区别"><img class="cover" src="https://cdn.jsdelivr.net/gh/sazxsdawn2022/picgoimg/img/cloud.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Component 和 @Configuration 的区别</div></div></a></div></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="lv-container" data-id="city" data-uid="MTAyMC81ODkzOS8zNTQwMQ=="></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/tx.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Daggry</div><div class="author-info__description">欢迎访问</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">32</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">11</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/sazxsdawn2022" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:huangxinpeng21@outlook.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">入秋后天气变得凉爽了<br/>小提示：左下角有音乐可以听哦</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1%E3%80%81%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">1、项目介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2%E3%80%81%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93"><span class="toc-number">2.</span> <span class="toc-text">2、项目总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3%E3%80%81%E9%A1%B9%E7%9B%AE%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.</span> <span class="toc-text">3、项目功能实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BC%9A%E8%AF%9D-Session"><span class="toc-number">3.1.</span> <span class="toc-text">分布式会话&#x2F;Session</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95"><span class="toc-number">3.1.1.</span> <span class="toc-text">用户登录</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95-%E5%9F%BA%E7%A1%80%E5%8A%9F%E8%83%BD"><span class="toc-number">3.1.1.1.</span> <span class="toc-text">用户登录-基础功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A0%A1%E9%AA%8C%E6%B3%A8%E8%A7%A3"><span class="toc-number">3.1.1.2.</span> <span class="toc-text">自定义校验注解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%B0%E5%BD%95%E7%99%BB%E5%BD%95%E7%94%A8%E6%88%B7Session"><span class="toc-number">3.1.1.3.</span> <span class="toc-text">记录登录用户Session</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8FSession%E5%85%B1%E4%BA%AB"><span class="toc-number">3.1.2.</span> <span class="toc-text">分布式Session共享</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SpringSession-%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F-Session"><span class="toc-number">3.1.2.1.</span> <span class="toc-text">SpringSession 实现分布式 Session</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E5%B0%86%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E7%BB%9F%E4%B8%80%E6%94%BE%E5%88%B0Redis"><span class="toc-number">3.1.2.2.</span> <span class="toc-text">直接将用户信息统一放到Redis</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#WebMvcConfiger%E4%BC%98%E5%8C%96%E7%99%BB%E5%BD%95"><span class="toc-number">3.1.2.3.</span> <span class="toc-text">WebMvcConfiger优化登录</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A7%92%E6%9D%80%E5%9F%BA%E6%9C%AC%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91"><span class="toc-number">3.2.</span> <span class="toc-text">秒杀基本功能开发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%95%86%E5%93%81%E5%88%97%E8%A1%A8"><span class="toc-number">3.2.1.</span> <span class="toc-text">商品列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5"><span class="toc-number">3.2.2.</span> <span class="toc-text">商品详情页</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A7%92%E6%9D%80%E5%9F%BA%E6%9C%AC%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.2.3.</span> <span class="toc-text">秒杀基本实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD1-%E7%A7%92%E6%9D%80%E5%80%92%E8%AE%A1%E6%97%B6"><span class="toc-number">3.2.3.1.</span> <span class="toc-text">功能1-秒杀倒计时</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD2-%E7%A7%92%E6%9D%80%E6%8C%89%E9%92%AE"><span class="toc-number">3.2.3.2.</span> <span class="toc-text">功能2-秒杀按钮</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD3-%E7%82%B9%E5%87%BB%E6%8C%89%E9%92%AE%E5%8F%AF%E4%BB%A5%E7%A7%92%E6%9D%80"><span class="toc-number">3.2.3.3.</span> <span class="toc-text">功能3-点击按钮可以秒杀</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A7%92%E6%9D%80%E5%8E%8B%E6%B5%8BJmeter"><span class="toc-number">3.3.</span> <span class="toc-text">秒杀压测Jmeter</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E7%94%A8%E6%88%B7%E6%B5%8B%E8%AF%95"><span class="toc-number">3.3.1.</span> <span class="toc-text">多用户测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B5%E9%9D%A2%E4%BC%98%E5%8C%96"><span class="toc-number">3.4.</span> <span class="toc-text">页面优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#redis%E9%A1%B5%E9%9D%A2%E7%BC%93%E5%AD%98"><span class="toc-number">3.4.1.</span> <span class="toc-text">redis页面缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E7%BC%93%E5%AD%98"><span class="toc-number">3.4.2.</span> <span class="toc-text">对象缓存</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E8%B4%AD%E5%92%8C%E8%B6%85%E5%8D%96"><span class="toc-number">3.5.</span> <span class="toc-text">复购和超卖</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B6%85%E5%8D%96"><span class="toc-number">3.5.1.</span> <span class="toc-text">超卖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E8%B4%AD"><span class="toc-number">3.5.2.</span> <span class="toc-text">复购</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A7%92%E6%9D%80%E4%BC%98%E5%8C%96"><span class="toc-number">3.6.</span> <span class="toc-text">秒杀优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%84%E5%87%8F%E5%BA%93%E5%AD%98-Decrement"><span class="toc-number">3.6.1.</span> <span class="toc-text">预减库存+Decrement</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E5%85%A5%E5%86%85%E5%AD%98%E6%A0%87%E8%AE%B0"><span class="toc-number">3.6.2.</span> <span class="toc-text">加入内存标记</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E5%85%A5%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%8C%E7%A7%92%E6%9D%80%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82"><span class="toc-number">3.6.3.</span> <span class="toc-text">加入消息队列，秒杀异步请求</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A7%92%E6%9D%80%E5%AE%89%E5%85%A8"><span class="toc-number">3.7.</span> <span class="toc-text">秒杀安全</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A7%92%E6%9D%80%E6%8E%A5%E5%8F%A3%E5%9C%B0%E5%9D%80%E9%9A%90%E8%97%8F"><span class="toc-number">3.7.1.</span> <span class="toc-text">秒杀接口地址隐藏</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E7%A0%81%E9%98%B2%E6%AD%A2%E8%84%9A%E6%9C%AC%E6%94%BB%E5%87%BB"><span class="toc-number">3.7.2.</span> <span class="toc-text">验证码防止脚本攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A7%92%E6%9D%80%E6%8E%A5%E5%8F%A3%E9%99%90%E6%B5%81-%E9%98%B2%E5%88%B7"><span class="toc-number">3.7.3.</span> <span class="toc-text">秒杀接口限流-防刷</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E6%8E%A5%E5%8F%A3%E9%99%90%E6%B5%81"><span class="toc-number">3.7.3.1.</span> <span class="toc-text">简单接口限流</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E6%8E%A5%E5%8F%A3%E9%99%90%E6%B5%81"><span class="toc-number">3.7.3.2.</span> <span class="toc-text">通过接口限流</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/archives/947b043e.html" title="事务是什么"><img src="https://cdn.jsdelivr.net/gh/sazxsdawn2022/picgoimg/duskimg/blog/daisy-3392654_1280.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="事务是什么"/></a><div class="content"><a class="title" href="/archives/947b043e.html" title="事务是什么">事务是什么</a><time datetime="2023-06-26T12:00:00.000Z" title="发表于 2023-06-26 20:00:00">2023-06-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/archives/cced2ad1.html" title="数据一致性"><img src="https://cdn.jsdelivr.net/gh/sazxsdawn2022/picgoimg/duskimg/blog/chicken-4849979_1280.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="数据一致性"/></a><div class="content"><a class="title" href="/archives/cced2ad1.html" title="数据一致性">数据一致性</a><time datetime="2023-06-24T12:00:00.000Z" title="发表于 2023-06-24 20:00:00">2023-06-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/archives/b3d7f795.html" title="初识分布式系统"><img src="https://cdn.jsdelivr.net/gh/sazxsdawn2022/picgoimg/duskimg/blog/pexels-pixabay-461940.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="初识分布式系统"/></a><div class="content"><a class="title" href="/archives/b3d7f795.html" title="初识分布式系统">初识分布式系统</a><time datetime="2023-06-23T12:00:00.000Z" title="发表于 2023-06-23 20:00:00">2023-06-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/archives/c4e28c6e.html" title="回表"><img src="https://cdn.jsdelivr.net/gh/sazxsdawn2022/picgoimg/duskimg/blog/pexels-ylanite-koppens-1809344.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="回表"/></a><div class="content"><a class="title" href="/archives/c4e28c6e.html" title="回表">回表</a><time datetime="2023-05-09T14:00:00.000Z" title="发表于 2023-05-09 22:00:00">2023-05-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/archives/76572b50.html" title="索引底层的底层实现"><img src="https://cdn.jsdelivr.net/gh/sazxsdawn2022/picgoimg/duskimg/blog/pexels-pixabay-413960.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="索引底层的底层实现"/></a><div class="content"><a class="title" href="/archives/76572b50.html" title="索引底层的底层实现">索引底层的底层实现</a><time datetime="2023-05-08T14:00:00.000Z" title="发表于 2023-05-08 22:00:00">2023-05-08</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.jsdelivr.net/gh/sazxsdawn2022/picgoimg/duskimg/seckill/seckill.png')"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By Daggry</div><div class="footer_custom_text">很高兴遇见你</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>function loadLivere () {
  if (typeof LivereTower === 'object') {
    window.LivereTower.init()
  }
  else {
    (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
    })(document, 'script');
  }
}

if ('Livere' === 'Livere' || !false) {
  if (false) btf.loadComment(document.getElementById('lv-container'), loadLivere)
  else loadLivere()
}
else {
  function loadOtherComment () {
    loadLivere()
  }
}</script></div><div class="aplayer no-destroy" data-id="8711920373" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="true"> </div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>